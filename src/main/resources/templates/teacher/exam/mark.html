<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title></title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
    <script th:src="@{/js/jquery-3.5.1.js}"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>

    <style>
        #main {
            width: 800px;
            /*height: 100px;*/
            margin: 0 auto;
        }
        /*div无法点击*/
        .div-cant-click {
            pointer-events: none;
        }

    </style>

</head>
<body>

<p th:text="${examCode}" id="examCode" hidden></p>
<p th:text="${studentId}" id="studentId" hidden></p>
<p th:text="${studentName}" id="studentName" hidden></p>
<p th:text="${examName}" id="examName" hidden></p>

<!--<h5>mathjax转化测试</h5>-->
<!--<p>$$\frac{\partial f}{\partial x} = 2\,\sqrt{a}\,x$$</p>-->

<h3 id="head"></h3>

<from class="layui-form" >

<div id="main"></div>

    <div style="text-align:center">
        <button class="layui-btn "lay-submit="" lay-filter="" id="submit">完成批阅</button>
    </div>
</from>
<script type="text/html" id="questionTemplate">



        <a id="questionId" hidden="hidden"></a>

        <div>
            <!--<h3 class="layui-form-item" id="sequence"></h3>-->

            <h3 class="layui-form-item" id="question" type="text"></h3>
        </div>

        <p class="layui-form-item layui-elem-quote layui-quote-nm" id="studentAnswer">考生答案</p>
        <h4 class="layui-form-item layui-elem-quote layui-quote-nm" id="RightAnswer">正确答案</h4>

        <div class="layui-form-item">

            <div class="layui-form-item layui-elem-quote layui-quote-nm " id="fullScore">本题满分为</div>

            <div class="layui-form-item">
                <label class="layui-form-label">得分：</label>
                <div class="layui-input-inline">
                    <input type="text" placeholder="请打分" autocomplete="off" class="layui-input" id="score" lay-verify="required|number" value="">
                </div>
                <div class="layui-form-mid layui-word-aux">请不要超过最大分数</div>
            </div>

        </div>




    <hr>
    <br>

</script>




<script th:src="@{/layui/layui.js}" charset="utf-8"></script>

<script type="text/javascript" th:inline="none">



    var globalData;

    layui.use(['form', 'layedit', 'laydate'], function () {
        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;


        $.ajax({
            type: "get",
            url: '/paper/questions',
            data: {
                examCode: $("#examCode").text(),
                studentId: $("#studentId").text()
            },
            success: function (data) {
               // console.log(data.data);//数据获取到了
                globalData = data.data;
                var question = data.data;
                //开始动态渲染

                $("#head").text("考试科目：" + $("#examName").text() + '   学生：' + $("#studentName").text());
                for (let i = 0; i < question.length; i++) {
                    $("#main").append($("#questionTemplate").text());

                    $("#question").attr("id", "question" + i);     //题干
                    $("#questionId").attr("id", "questionId" + i);  //题目ID
                    $("#studentAnswer").attr("id", "studentAnswer" + i); //学生答案
                    $("#RightAnswer").attr("id", "RightAnswer" + i);  //正确答案
                    $("#fullScore").attr("id", "fullScore" + i);      //满分
                    $("#score").attr("id", "score" + i);      //打分
                }

                for (let i = 0; i < question.length; i++) {

                    $("#question" + i).text(i + 1 + '.' + question[i].question);
                    $("#questionId" + i).text(question[i].questionId);
                    $("#studentAnswer" + i).text('学生答案为：' + question[i].studentAnswer);
                    $("#RightAnswer" + i).text('正确答案为:' + question[i].rightAnswer);
                    $("#fullScore" + i).text('本题满分为：' + question[i].fullScore);
                    $("#score" + i).val(question[i].score);

                    window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, "question"+i]);
                    window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, "studentAnswer"+i]);
                    window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, "RightAnswer"+i]);

                }

                //$("#main").append($("#submitTemplate").text());
                //console.log($("#baseModel").text())
                form.render();

                //MathJax.Hub.Queue(['Typeset', MathJax.Hub]); //加这段代码

            }
        });

        //日期
        // laydate.render({
        //     elem: '#date'
        // });
        // laydate.render({
        //     elem: '#date1'
        // });


    });

    var questionIdList = [];
    var questionTypeList = [];
    var finalScoreList = [];

    $("#submit").click(function () {
        $("#submit").addClass("div-cant-click")
        for (let i=0; i < globalData.length; i++) {
            questionIdList[i] = globalData[i].questionId
            questionTypeList[i] = globalData[i].questionType
            finalScoreList[i] = $("#score"+i).val();
        }

        //console.log(questionIdList);
        //console.log(questionTypeList);
        //console.log(finalScoreList);

        let examCode =$("#examCode").text();
        let studentId = $("#studentId").text();

        $.ajax({
            url: "/paper/marked",
            data: {
                "questionIdList": questionIdList,
                "questionTypeList": questionTypeList,
                "finalScoreList": finalScoreList,
                "examCode":examCode,
                "studentId":studentId
            },
            dataType: "json",
            type: "post",
            traditional: true,
            success: function (data) {
                if(data.code==412){
                    layer.alert(data.message)
                    $("#submit").removeClass("div-cant-click")
                }else if(data.code==413) {
                    layer.alert(data.message)
                    $("#submit").removeClass("div-cant-click")
                }else {
                    layer.confirm(data.message,{
                        btn: ['确认'],
                        btn1: function(){
                            window.location.href = "/toPaperPage";
                        }
                    });
                }

                //top.location.href = "/teacherIndex";
            }

        })
    })


</script>


</body>
</html>